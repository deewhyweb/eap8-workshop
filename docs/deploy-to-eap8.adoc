= Migrate application from JBoss EAP 7.4 to {{ EAP8_VERSION }}
:experimental:
:imagesdir: images

{{ EAP8_VERSION }} introduces breaking changes to application written for JBoss EAP 7.4.  

To perform code analysis of our JBoss EAP 7.4 application, we will use the latest version of the Migration Toolkit for Runtimes. 

If {{ EAP8_VERSION }} is still running, switch to this terminal window and enter CTRL+C to exit.

[source,sh,role="copypaste"]
----
cd /shared
----

[source,sh,role="copypaste"]
----
unzip  {{ MTR_ARCHIVE }}
----

[source,sh,role="copypaste"]
----
cd {{ MTR_DIR }}
----

[source,sh,role="copypaste"]
----
export HOSTNAME=eap
----

[source,sh,role="copypaste"]
----
./run_windup.sh -Djboss.http.port=8090 -b 0.0.0.0
----

Once the Migration toolkit for application has started, you can open the landing page by clicking  http://{{ USER_ID }}-jboss-workshop-mtr.{{ ROUTE_SUBDOMAIN }}[here, window="_blank"]

image::mtr-1.png[migration,800]

From the MTR landing page, click on Create Project.

Enter a project name (e.g., eap7-eap8) and click on Next.

Then, we need to locate the application source code

[source,sh,role="copypaste"]
----
/projects/workshop/coolstore
----

Put a tick in the box next to "Directory contains the application's source code or an exploded Java application archive"

image::mtr-2.png[migration,800]

Set the target to "eap8"

image::mtr-3.png[migration,800]

Select the packages

image::mtr-4.png[migration,800]

Skip through the remaining screens

image::mtr-5.png[migration,800]

Click on "Save and Run"

Once the report has been generated you will see the analysis results as shown below

image::mtr-6.png[migration,800]

Click on the report icon (highlighted in the image) to view the report.

The report results will be shown as below 

image::mtr-7.png[migration,800]

You'll see from this report an estimation of 84 story points to migrate from JBoss EAP 7.4 to {{ EAP8_VERSION }}.

You can click through the various tabs of the report to view the details.  For example, clicking on the "Issues" tab will show the details of the changes required.

image::mtr-8.png[migration,800]

We can now shutdown the MTR Console by switching back to the terminal window and hitting CTRL+C


== Using the Migration Toolkit for Runtimes VS Code extension

First we need to unzip the Migratio Toolkit for Runtimes CLI tool

[source,sh,role="copypaste"]
----
cd /shared
----

[source,sh,role="copypaste"]
----
unzip {{ MTR_CLI_ARCHIVE }} 
----

Add the VS-Code Migration Toolkit for Runtimes extension 

image::mtr-vscode.png[migration,800]

Configure the MTR VS-Code extension as follows

image::mtr-vscode-2.png[migration,800]

/shared/mtr-cli-1.1.0.GA-redhat-00003/bin/windup-cli

/projects/workshop/coolstore

To perform the code analysis, click on the start button as shown below

image::mtr-vscode-3.png[migration,400]

Once the analysis is complete, you should see a file hierachy in the left hand window.  CLicking on a file will open up the editor showing where the issues are with the file.

image::mtr-vscode-4.png[migration,800]

You can make the edits directly in the file as indicated, or in some cases you can right click on the file and select "Apply all quickfixes"

image::mtr-vscode-5.png[migration,400]

Open /projects/workshop/coolstore/src/main/java/com/redhat/coolstore/service/OrderServiceMDB.java/OrderServiceMDB.java and change

@ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Topic")

to 

@ActivationConfigProperty(propertyName = "destinationType", propertyValue = "jakarta.jms.Topic"),

== Remaining file changes

Other than the namespace changes, the migration toolkit for runtimes report identified changes in the following files:

* pom.xml
* persistence.xml
* faces-config.xml

We can go through the changes as detailed in the report, or copy these files from a pre-prepared {{ EAP8_VERSION }} version of the app in the /projects/jboss7-quickstarts/sample-app-eap8 folder by running the following commands.

[source,sh,role="copypaste"]
----
cp /projects/workshop/coolstore-eap8/pom.xml /projects/workshop/coolstore
----

[source,sh,role="copypaste"]
----
cp /projects/workshop/coolstore-eap8/src/main/resources/META-INF/persistence.xml /projects/workshop/coolstore/src/main/resources/META-INF/
----

We can now deploy our {{ EAP8_VERSION }} application

Shut down the Migration Toolkit for Runtimes

[source,sh,role="copypaste"]
----
export EAP_HOME=/shared/{{ JBOSS8_DIR }}  
----

[source,sh,role="copypaste"]
----
$EAP_HOME/bin/standalone.sh  -c standalone-full-ha.xml -Djboss.http.port=8100 -b 0.0.0.0
----

In a second terminal enter the following from the /projects/jboss7-quickstarts/sample-app folder

[source,sh,role="copypaste"]
----
mvn clean package
----

You will now be able to access the application by by clicking http://{{ USER_ID }}-jboss-workshop-eap8.{{ ROUTE_SUBDOMAIN }}[here, window="_blank"]

The coolstore application should load as follows

image::coolstore.png[public-endpoint,800]

We've now successfully deployed our sample application to {{ EAP8_VERSION }} connecting to an external PostgreSQL database.
