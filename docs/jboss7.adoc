= Deployment of a sample application on JBoss EAP 7.4 
:experimental:
:imagesdir: images

In this section we're going to deploy an application to JBoss EAP 7.4.  The sample application we're providing can be found in the IDE in the "workshop/coolstore" folder.

The application requires two external dependencies, a connection to a PostgreSQL database and an instance of Red Hat SSO. The application also uses a message queue, for this example we will use the embedded message queue provided with JBoss EAP.

We've provisioned a database in your dev spaces environment with the following connection details.

* Hostname: 127.0.0.1
* Port: 5432
* User name: postgresUser
* Password: postgresPW
* Database name: postgresDB

We've also provisioned an instance of Red Hat SSO.  This instance is available here: https://keycloak-sso.{{ ROUTE_SUBDOMAIN }}[keycloak, window="_blank"]

First, we're going to configure a connection to the PostgreSQL database. We're going to perform these steps from the dev spaces environment we logged into in the previous section.  Access your dev spaces environment with this {{ CHE_URL }}[link^].

Access the terminal in dev spaces by clicking on "Menu" -> "Terminal" -> "New Terminal"

image::open-terminal.png[open-terminal,800]

A JBoss 7.4 instance is already provisioned in the /shared/{{ JBOSS7_DIR }} folder and available at: http://{{ USER_ID }}-jboss-workshop-eap7.{{ ROUTE_SUBDOMAIN }}[here, window="_blank"]

== Adding the PostgreSQL module, drivers and JMS topic

We can now add the PostgreSQL module and drivers.

Make a folder srtucture in EAP_HOME/modules with command:

[source,sh,role="copypaste"]
----
mkdir -p /shared//{{ JBOSS7_DIR }}/modules/org/postgresql/main
----

Copy the postgreSQL driver from the shared folder

[source,sh,role="copypaste"]
----
cp /shared/postgresql-42.6.0.jar /shared//{{ JBOSS7_DIR }}/modules/org/postgresql/main
----

Make a modules.xml file in $EAP_HOME/modules/org/postgresql/main referencing the postgreSQL driver.
[source,sh,role="copypaste"]
----
cat << EOF > /shared/{{ JBOSS7_DIR }}/modules/org/postgresql/main/module.xml
<?xml version="1.0" ?>
<module xmlns="urn:jboss:module:1.1" name="org.postgresql">
  <resources>
    <resource-root path="postgresql-42.6.0.jar"/>
  </resources>
  <dependencies>
    <module name="javaee.api"/>
    <module name="sun.jdk"/>
    <module name="ibm.jdk"/>
    <module name="javax.api"/>
    <module name="javax.transaction.api"/>
  </dependencies>
</module>
EOF
----

Enter the following commands to launch the jboss-cli and connect to JBoss 7.4

[source,sh,role="copypaste"]
----
 /shared/{{ JBOSS7_DIR }}/bin/jboss-cli.sh --connect --controller=127.0.0.1:10090
----

Run the following commands in the JBoss CLI to add the postgreSQL datsource and connection information:
[source,sh,role="copypaste"]
----
/subsystem=datasources/jdbc-driver=postgresql:add(driver-name=postgresql,driver-module-name=org.postgresql)
----

[source,sh,role="copypaste"]
----
data-source add --name=postgresql --jndi-name=java:jboss/datasources/CoolstoreDS --driver-name=postgresql --connection-url=jdbc:postgresql://127.0.0.1:5432/postgresDB --user-name=postgresUser --password=postgresPW
----

Our application uses message driven beans which require a jms topic and the activemq messaging subsystem enabled.  To configure these, enter the following commands.

[source,sh,role="copypaste"]
----
jms-topic add --topic-address=topic.orders --entries=/orders
----

[source,sh,role="copypaste"]
----
/subsystem=messaging-activemq/server=default:write-attribute(name=cluster-password, value=password)
----

[source,sh,role="copypaste"]
----
reload
----

[source,sh,role="copypaste"]
----
exit
----

If we login to the http://{{ USER_ID }}-jboss-workshop-eap7-console.{{ ROUTE_SUBDOMAIN }}[JBoss EAP 7.4 Admin console, window="_blank"] we should be able to see the postgresql datasource connection by navigating to "Configuration" -> "Subsystems" -> "Datasources & Drivers" -> "Datasources" -> "postgresql".  

image::jboss7-console-datasource.png[datasource,800]

We can also view the JMS topic we created by clicking http://{{ USER_ID }}-jboss-workshop-eap7-console.{{ ROUTE_SUBDOMAIN }}/console/index.html#messaging-server-destination;server=default[here, window="_blank"]

and then selecting "JMS Topic".

image::jboss7-console-jms.png[jms,800]

Next, we need to set the url of our Red Hat SSO application.  In the IDE, open the file: coolstore/src/main/webapp/keycloak.json and edit the contents so they look like the following:

[source,json,role="copypaste"]
----
{
    "realm": "eap",
    "auth-server-url": "https://keycloak-sso.{{ ROUTE_SUBDOMAIN }}/auth",
    "ssl-required": "external",
    "resource": "eap-app",
    "public-client": true,
    "confidential-port": 0
}
----

We are now ready to deploy our JBoss EAP 7.4 application, run the following commands to build the application:

[source,sh,role="copypaste"]
----
cd /projects/workshop/coolstore
----

[source,sh,role="copypaste"]
----
mvn clean package
----

[source,sh,role="copypaste"]
----
/shared/{{ JBOSS7_DIR }}/bin/jboss-cli.sh --connect --controller=127.0.0.1:10090
----

Run the following command to deploy the application:


[source,sh,role="copypaste"]
----
deploy ./target/ROOT.war
----

You will now be able to access the coolstore application http://{{ USER_ID }}-jboss-workshop-eap7.{{ ROUTE_SUBDOMAIN }}[here, window="_blank"]

The coolstore application should load as follows:

image::coolstore.png[coolstore,800]

We've now successfully deployed our sample application to JBoss EAP 7.4 connecting to an external PostgreSQL database.

You can test the SSO integration by clicking on the "Sign In" button on the top right hand corner of the screen.

image::sign-in.png[sign-in,800]

You should see the Red Hat SSO login screen

image::rhsso-login.png[rhsso-login,800]

You can login to SSO with the credentials

* *Username*: `{{ USER_ID }}`
* *Password*: openshift

Before we move onto deploying to {{ EAP8_VERSION }} we're going to undeploy the coolstore application

Switch back to the second terminal and enter the following commands


[source,sh,role="copypaste"]
----
undeploy ROOT.war
----

[source,sh,role="copypaste"]
----
exit
----