= Traditional app deployment on JBoss 7.4
:experimental:
:imagesdir: images

The release of {{ EAP8_VERSION }} provides support for https://jakarta.ee/release/10/[Jakarta EE 10, window="_blank"]. Jakarta EE 10 brings a huge change to Jakarta EE compared to the Jakarta EE 8 specifications supported by EAP 7. 

Moving applications from JBoss EAP 7.4 to {{ EAP8_VERSION }} will require code changes due to the move from Jakarta EE 8 to Jakarta EE 10 (e.g., converting from the “javax” namespace to “jakarta” namespace). These changes are documented in this https://access.redhat.com/articles/6980265[article, window="_blank"]. To help our customers with this migration effort we've updated our tools: the https://developers.redhat.com/products/mta/download[Migration Toolkit for Applications, window="_blank"], including the Migration Toolkit for Runtimes (MTR, for non-OpenShift projects) and the JBoss EAP Server Migration tool. 

In this section we're going to use the JBoss EAP Server Migration tool migrate the server configuration from JBoss EAP 7.4 to {{ EAP8_VERSION }}

Before starting the migration, ensure the JBoss EAP 7.4 server is shutdown and create an environment variable pointing to the JBoss EAP 7.4 deployment.

If JBoss EAP 7.4 is still running, switch to this tab and press CTRL + C to stop the server

[source,sh,role="copypaste"]
----
export EAP_PREVIOUS_HOME=/shared/{{ JBOSS7_DIR }}
----

We are now going to deploy an instance of {{ EAP8_VERSION }}.

You will find a {{ EAP8_VERSION }} archive in the "/shared" folder.  From the terminal enter the following commands:

[source,sh,role="copypaste"]
----
cd /shared
----

[source,sh,role="copypaste"]
----
unzip {{ JBOSS8_ARCHIVE }} 
----

Set the EAP_HOME environment variable as follows:

[source,sh,role="copypaste"]
----
export EAP_HOME=/shared/{{ JBOSS8_DIR }} 
----

Now we can move on to the migration from JBoss EAP 7.4 to {{ EAP8_VERSION }}.

## Server configuration changes

When we deployed our application to JBoss EAP 7.4, we made some changes to the server configuration to add a module and driver to connect to PostgreSQL and to configure the message queue. We must ensure these modules and drivers are in place and working correctly in our {{ EAP8_VERSION }} server. We can use the JBoss EAP server migration tool to perform this migration for us.  

We have provided a distribution archive for the server migration tool in the /shared folder.  To extract this, follow these steps:

[source,sh,role="copypaste"]
----
cd /shared
----

[source,sh,role="copypaste"]
----
unzip {{ SERVER_MIGRATION_ARCHIVE }}
----

[source,sh,role="copypaste"]
----
cd {{ SERVER_MIGRATION_DIR }}
----

To run the server migration tool to migrate from our JBoss 7.4 instance to our {{ EAP8_VERSION }} instance, run the following command:

[source,sh,role="copypaste"]
----
./jboss-server-migration.sh -s $EAP_PREVIOUS_HOME -t $EAP_HOME
----

The server migration tool will ask a series of questions during the migration process:

image::mig1.png[migration,1150]
Choose yes to migrate the standalone configuration.

image::mig2.png[migration,1150]
Choose no. We want to select the configurations to migrate.

image::mig3.png[migration,1150]
Choose yes. We want to migrate standalone-full-ha.xml.

image::mig4.png[migration,1150]
Choose no. We don’t want to migrate standalone-full.xml

image::mig5.png[migration,1150]
Choose no. We don’t want to migrate standalone-ha.xml.

image::mig6.png[migration,1150]
Choose no. We don’t want to migrate standalone-load-balancer.xml.

image::mig7.png[migration,1150] 
Choose no. We don't want to migrate standalone.xml.

image::mig8.png[migration,1150]
Choose no. We are not using a managed domain.

image::mig9.png[migration,1150]

Once this operation completes, we can start our {{ EAP8_VERSION }} server with the following command from the JBoss EAP installation folder:

[source,sh,role="copypaste"]
----
$EAP_HOME/bin/standalone.sh  -c standalone-full-ha.xml  -Djboss.http.port=8100 -b 0.0.0.0
----

We've added the "-Djboss.http.port=8100" flag to launch {{ EAP8_VERSION }} listening on port 8100, to anable us to connect to this on a different route to the JBoss EAP 7.4 instances.

You should now be able to access the EAP 8 landing page by clicking http://{{ USER_ID }}-jboss-workshop-eap8.{{ ROUTE_SUBDOMAIN }}[here, window="_blank"]

image::eap8-landing.png[eap8-landing,1150]

When the server has started successfully, we can test our configuration with the following commands.

Open a new terminal window and enter:

[source,sh,role="copypaste"]
----
export EAP_HOME=/shared/{{ JBOSS8_DIR }} 
----

[source,sh,role="copypaste"]
----
$EAP_HOME/bin/jboss-cli.sh --connect
----

[source,sh,role="copypaste"]
----
/subsystem=datasources:installed-drivers-list
----

The output should show the PostgreSQL driver as follows:
[source]
----
{
    "outcome" => "success",
    "result" => [
        {
            "driver-name" => "postgresql",
            "deployment-name" => undefined,
            "driver-module-name" => "org.postgresql",
            "module-slot" => "main",
            "driver-datasource-class-name" => "",
            "driver-xa-datasource-class-name" => "",
            "datasource-class-info" => undefined,
            "driver-class-name" => "org.postgresql.Driver",
            "driver-major-version" => 42,
            "driver-minor-version" => 6,
            "jdbc-compliant" => false
        },
        {
            "driver-name" => "h2",
            "deployment-name" => undefined,
            "driver-module-name" => "com.h2database.h2",
            "module-slot" => "main",
            "driver-datasource-class-name" => "",
            "driver-xa-datasource-class-name" => "org.h2.jdbcx.JdbcDataSource",
            "datasource-class-info" => [{"org.h2.jdbcx.JdbcDataSource" => {
                "URL" => "java.lang.String",
                "description" => "java.lang.String",
                "loginTimeout" => "int",
                "password" => "java.lang.String",
                "url" => "java.lang.String",
                "user" => "java.lang.String"
            }}],
            "driver-class-name" => "org.h2.Driver",
            "driver-major-version" => 2,
            "driver-minor-version" => 1,
            "jdbc-compliant" => true
        }
    ]
}
----

We can also test our datasource connection with the following JBoss CLI command:

[source,sh,role="copypaste"]
----
/subsystem=datasources/data-source=postgresql:test-connection-in-pool
----

A successful connection should result in the following response:
[source]
----
{

    "outcome" => "success",

    "result" => [true]

}
----
We can now be confident our application will have the required drivers and data sources present.

{{ EAP8_VERSION }} is now successfully deployed and the server configuration migrated from JBoss EAP 7.4