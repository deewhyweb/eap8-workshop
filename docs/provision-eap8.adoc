= Traditional app deployment on JBoss 7.4
:experimental:
:imagesdir: images

The release of {{ EAP8_VERSION }} provides support for https://jakarta.ee/release/10/[Jakarta EE 10, window="_blank"]. Jakarta EE 10 brings a huge change to Jakarta EE compared to the Jakarta EE 8 specifications supported by EAP 7. 

Moving applications from JBoss EAP 7.4 to {{ EAP8_VERSION }} will require code changes due to the move from Jakarta EE 8 to Jakarta EE 10 (e.g., converting from the “javax” namespace to “jakarta” namespace). These changes are documented in this https://access.redhat.com/articles/6980265[article, window="_blank"]. To help our customers with this migration effort we've updated our tools: the https://developers.redhat.com/products/mta/download[Migration Toolkit for Applications, window="_blank"], including the Migration Toolkit for Runtimes (MTR, for non-OpenShift projects) and the JBoss EAP Server Migration tool. 

In this section we're going to use the JBoss EAP Server Migration tool migrate the server configuration from JBoss EAP 7.4 to {{ EAP8_VERSION }}

## Server configuration changes

When we deployed our application to JBoss EAP 7.4, we made some changes to the server configuration to add a module and driver to connect to PostgreSQL and to configure the message queue. We must ensure these modules and drivers are in place and working correctly in our {{ EAP8_VERSION }} server. We can use the JBoss EAP server migration tool to perform this migration for us.  

We have provided a distribution archive for the server migration tool in the /shared folder.  To extract this, follow these steps:

[source,sh,role="copypaste"]
----
cd /shared
----

[source,sh,role="copypaste"]
----
unzip {{ SERVER_MIGRATION_ARCHIVE }}
----

[source,sh,role="copypaste"]
----
cd {{ SERVER_MIGRATION_DIR }}
----

The workshop has two instances of JBoss EAP deployed.

JBoss EAP 7.4 with a home directory of /shared/jboss-eap-7.4 stored in the EAP7_HOME environment variable

{{ EAP8_VERSION }} with a home directory of /shared/{{ JBOSS8_DIR }} stored in the EAP8_HOME environment variable.

Our JBoss 7.4 instance is using the "standalone_full.xml" configuration, so this is the only one we need to migrate from JBoss EAP 7.4 to {{ EAP8_VERSION }}.

To run the server migration tool to migrate from our JBoss 7.4 instance to our {{ EAP8_VERSION }} instance, run the following command:

[source,sh,role="copypaste"]
----
./jboss-server-migration.sh -s $EAP7_HOME -t $EAP8_HOME
----

The server migration tool will ask a series of questions during the migration process:

image::mig1.png[migration,1150]
Choose *yes.* to migrate the standalone configuration.

image::mig2.png[migration,1150]
Choose no. We want to select the configurations to migrate.

image::mig3.png[migration,1150]
Choose no. We don't want to migrate standalone-full-ha.xml.

image::mig4.png[migration,1150]
Choose *yes.* We want to migrate standalone-full.xml

image::mig5.png[migration,1150]
Choose no. We don’t want to migrate standalone-ha.xml.

image::mig6.png[migration,1150]
Choose no. We don’t want to migrate standalone-load-balancer.xml.

image::mig7.png[migration,1150] 
Choose no. We don't want to migrate standalone.xml.

image::mig8.png[migration,1150]
Choose no. We are not using a managed domain.

image::mig9.png[migration,1150]

We can now connect to JBoss EAP 8 by running the following command

[source,sh,role="copypaste"]
----
$EAP8_HOME/bin/jboss-cli.sh --connect --controller=127.0.0.1:10190
----

We will now trigger a reload of the {{ EAP8_VERSION }} server.

[source,sh,role="copypaste"]
----
reload
----

And look at the list of installed drivers.

[source,sh,role="copypaste"]
----
/subsystem=datasources:installed-drivers-list
----

The output should show the PostgreSQL driver as follows:
[source]
----
{
    "outcome" => "success",
    "result" => [
        {
            "driver-name" => "postgresql",
            "deployment-name" => undefined,
            "driver-module-name" => "org.postgresql",
            "module-slot" => "main",
            "driver-datasource-class-name" => "",
            "driver-xa-datasource-class-name" => "",
            "datasource-class-info" => undefined,
            "driver-class-name" => "org.postgresql.Driver",
            "driver-major-version" => 42,
            "driver-minor-version" => 6,
            "jdbc-compliant" => false
        },
        {
            "driver-name" => "h2",
            "deployment-name" => undefined,
            "driver-module-name" => "com.h2database.h2",
            "module-slot" => "main",
            "driver-datasource-class-name" => "",
            "driver-xa-datasource-class-name" => "org.h2.jdbcx.JdbcDataSource",
            "datasource-class-info" => [{"org.h2.jdbcx.JdbcDataSource" => {
                "URL" => "java.lang.String",
                "description" => "java.lang.String",
                "loginTimeout" => "int",
                "password" => "java.lang.String",
                "url" => "java.lang.String",
                "user" => "java.lang.String"
            }}],
            "driver-class-name" => "org.h2.Driver",
            "driver-major-version" => 2,
            "driver-minor-version" => 1,
            "jdbc-compliant" => true
        }
    ]
}
----

And test our datasource connection with the following JBoss CLI command:

[source,sh,role="copypaste"]
----
/subsystem=datasources/data-source=postgresql:test-connection-in-pool
----

A successful connection should result in the following response:
[source]
----
{

    "outcome" => "success",

    "result" => [true]

}
----

We can also login to the {{ EAP8_VERSION }} admin console https://{{ USER_ID }}-jboss-workshop-eap8-console.{{ ROUTE_SUBDOMAIN }}[here, window="_blank"]

we should be able to see the postgresql datasource connection by navigating to "Configuration" -> "Subsystems" -> "Datasources & Drivers" -> "Datasources" -> "postgresql".  

image::jboss8-console-datasource.png[datasource,800]

We can also view the JMS topic we created by clicking https://{{ USER_ID }}-jboss-workshop-eap8-console.{{ ROUTE_SUBDOMAIN }}/console/index.html#messaging-server-destination;server=default[here, window="_blank"]

and then selecting "JMS Topic".

image::jboss8-console-jms.png[jms,800]

We can now be confident our application will have the required drivers and data sources present.

{{ EAP8_VERSION }} is now successfully deployed and the server configuration migrated from JBoss EAP 7.4